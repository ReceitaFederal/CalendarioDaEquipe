<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Calendário da Equipe</title>

  <link
    href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css"
    rel="stylesheet"
  />
  <script
    src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"
    defer
  ></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #timeline { border: 1px solid #ddd; height: 600px; margin-top: 10px; }
    .controls button { margin: 5px; }
    #dropZone { border: 2px dashed #bbb; padding: 10px; text-align: center; margin-bottom: 10px; }
    #dropZone.dragover { border-color: #666; background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>Calendário da Equipe</h1>

  <div class="controls">
    <button id="btnReset">Limpar Calendário</button>
    <button id="btnLoadConfig">Carregar Configuração</button>
    <button id="btnLoadCSV">Carregar CSV</button>
    <button id="btnSaveAll">Salvar Calendário Completo</button>
    <button id="btnLoadAll">Carregar Calendário Completo</button>
    <input type="file" id="fileInput" style="display:none" />
  </div>

  <div id="dropZone">Arraste arquivos JSON ou CSV aqui</div>
  <div id="timeline"></div>

  <script>
    let config = null;
    let registros = [];
    let container, timeline;
    let groups, items;

    document.addEventListener("DOMContentLoaded", () => {
      container = document.getElementById("timeline");
      inicializarEstruturas();
      inicializarTimeline();
      configurarEventos();
    });

    function inicializarEstruturas() {
      groups = new vis.DataSet();
      items  = new vis.DataSet();
    }

    function inicializarTimeline() {
      const options = { stack:true, orientation:'top', margin:{item:10, axis:5} };
      timeline = new vis.Timeline(container, items, groups, options);
    }

    function configurarEventos() {
      document.getElementById("btnReset").onclick = resetarTimeline;
      document.getElementById("btnLoadConfig").onclick = () => selecionarArquivo("json", carregarConfigArquivo);
      document.getElementById("btnLoadCSV").onclick = () => selecionarArquivo("csv", carregarCSVArquivo);
      document.getElementById("btnSaveAll").onclick = salvarCalendarioCompleto;
      document.getElementById("btnLoadAll").onclick = () => selecionarArquivo("json", carregarCalendarioCompleto);

      const dropZone = document.getElementById("dropZone");
      dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
      dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
      dropZone.addEventListener("drop", e => {
        e.preventDefault(); dropZone.classList.remove("dragover");
        [...e.dataTransfer.files].forEach(f => processarArquivoDrop(f));
      });
    }

    function resetarTimeline() {
      inicializarEstruturas();
      timeline.setGroups(groups);
      timeline.setItems(items);
      config = null;
      registros = [];
    }

    function selecionarArquivo(tipo, callback) {
      const input = document.getElementById("fileInput");
      input.accept = tipo === "json" ? ".json" : ".csv";
      input.onchange = e => { 
        console.log (e.target.files[0]);
        console.dir(e);
        if(e.target.files[0]){
          callback(e.target.files[0]); 
        }
      };

      input.click();
    }

    function processarArquivoDrop(file) {
      if(file.name.endsWith(".json")) carregarConfigArquivo(file);
      else if(file.name.endsWith(".csv")) carregarCSVArquivo(file);
    }

    function carregarConfigArquivo(file) {
      lerArquivo(file).then(text => {
        config = JSON.parse(text);
        console.log("Configuração carregada", config);
      });
    }

    function carregarCSVArquivo(file) {
      if(!config) { alert("Carregue primeiro uma configuração JSON."); return; }
      lerArquivo(file).then(text => {
        const sep = identificarSeparador(text);
        const dados = parseCSV(text, sep);
        // Identificar arquivo correspondente no config
        const match = config.arquivos.find(a => file.name.includes(a.identificador_arquivo || ""));
        if(!match) { alert("CSV não corresponde a nenhuma entrada na configuração."); return; }
        dados.forEach(r => r.__campos = match.campos);
        registros.push(...dados);
        atualizarTimeline();
      });
    }

    function atualizarTimeline() {
      groups.clear(); items.clear();

      let nextId=1;
      const m1=new Map(), m2=new Map(), m3=new Map();

      registros.forEach(r => {
        const c=r.__campos;
        const n1=r[c.equipe_pai2], n2=r[c.equipe_pai], n3=r[c.equipe];
        if(n1 && !m1.has(n1)) m1.set(n1,nextId++);
        if(n2 && !m2.has(n2)) m2.set(n2,nextId++);
        if(n3 && !m3.has(n3)) m3.set(n3,nextId++);
      });

      const c0=registros[0]?.__campos;
      if(!c0) return;

      m1.forEach((id,nome)=>{
        const filhos=new Set();
        registros.forEach(r=>{ if(r[c0.equipe_pai2]===nome && r[c0.equipe_pai] && m2.has(r[c0.equipe_pai])) filhos.add(m2.get(r[c0.equipe_pai])); });
        groups.add({id,content:nome,treeLevel:1,nestedGroups:[...filhos]});
      });
      m2.forEach((id,nome)=>{
        const filhos=new Set();
        registros.forEach(r=>{ if(r[c0.equipe_pai]===nome && r[c0.equipe] && m3.has(r[c0.equipe])) filhos.add(m3.get(r[c0.equipe])); });
        groups.add({id,content:nome,treeLevel:2,nestedGroups:[...filhos]});
      });
      m3.forEach((id,nome)=>groups.add({id,content:nome,treeLevel:3}));

      registros.forEach(r=>{
        const c=r.__campos; if(!r[c.inicio]||!r[c.fim]) return;
        items.add({id:`${r[c.id]}-${r[c.inicio]}`,content:r[c.nome],start:r[c.inicio],end:r[c.fim],group:m3.get(r[c.equipe])});
      });

      timeline.setGroups(groups);
      timeline.setItems(items);
    }

    function salvarCalendarioCompleto() {
      if(!config) { alert("Nenhuma configuração carregada."); return; }
      const dados={config,registros};
      const blob=new Blob([JSON.stringify(dados)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;a.download="calendario_completo.json";a.click();
      URL.revokeObjectURL(url);
    }

    function carregarCalendarioCompleto(file) {
      lerArquivo(file).then(text=>{
        const obj=JSON.parse(text);
        config=obj.config;
        registros=obj.registros;
        atualizarTimeline();
      });
    }

    function lerArquivo(file) {
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=e=>res(e.target.result);
        r.onerror=e=>rej(e);
        r.readAsText(file);
      });
    }

    function identificarSeparador(text) {
      return text.includes(";") ? ";" : ",";
    }

    function parseCSV(texto, sep=",") {
      const linhas=texto.trim().split("\n");
      const cab=linhas.shift().split(sep).map(h=>h.trim());
      return linhas.map(l=> {
        const cols=l.split(sep).map(c=>c.trim());
        return Object.fromEntries(cab.map((h,i)=>[h,cols[i]]));
      });
    }
  </script>
</body>
</html>
