<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Calendário da Equipe</title>

  <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js" defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #timeline {
      border: 1px solid #ddd;
      height: 600px;
      margin-top: 10px;
    }

    .controls button {
      margin: 5px;
    }

    #dropZone {
      border: 2px dashed #bbb;
      padding: 10px;
      text-align: center;
      margin-bottom: 10px;
    }

    #dropZone.dragover {
      border-color: #666;
      background: #f0f0f0;
    }
  </style>
</head>

<body>
  <h1>Calendário da Equipe</h1>

  <div class="controls">
    <button id="btnReset">Limpar Calendário</button>
    <button id="btnLoadConfig">Carregar Configuração</button>
    <button id="btnLoadCSV">Carregar CSV</button>
    <button id="btnSaveAll">Salvar Calendário Completo</button>
    <button id="btnLoadAll">Carregar Calendário Completo</button>
    <input type="file" id="fileInput" style="display:none" />
  </div>

  <div id="dropZone">Arraste arquivos JSON ou CSV aqui</div>
  <div id="timeline"></div>

  <script>
    let config = null;
    let registros = [];
    let container, timeline;
    let items;

    document.addEventListener("DOMContentLoaded", () => {
      container = document.getElementById("timeline");
      inicializarEstruturas();
      inicializarTimeline();
      configurarEventos();
    });

    function inicializarEstruturas() {
      items = new vis.DataSet();
    }

    function inicializarTimeline() {
      const options = { stack: true, orientation: 'top', margin: { item: 10, axis: 5 } };
      timeline = new vis.Timeline(container, items, options);
    }

    function configurarEventos() {
      document.getElementById("btnReset").onclick = resetarTimeline;
      document.getElementById("btnLoadConfig").onclick = () => selecionarArquivo("json", carregarConfigArquivo);
      document.getElementById("btnLoadCSV").onclick = () => selecionarArquivo("csv", carregarCSVArquivo);
      document.getElementById("btnSaveAll").onclick = salvarCalendarioCompleto;
      document.getElementById("btnLoadAll").onclick = () => selecionarArquivo("json", carregarCalendarioCompleto);

      const dropZone = document.getElementById("dropZone");
      dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
      dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
      dropZone.addEventListener("drop", e => {
        e.preventDefault(); dropZone.classList.remove("dragover");
        [...e.dataTransfer.files].forEach(f => processarArquivoDrop(f));
      });
    }

    function resetarTimeline() {
      inicializarEstruturas();
      timeline.setItems(items);
      config = null;
      registros = [];
    }

    function selecionarArquivo(tipo, callback) {
      const input = document.getElementById("fileInput");
      input.accept = tipo === "json" ? ".json" : ".csv";
      input.onchange = e => {
        if (e.target.files[0]) {
          callback(e.target.files[0]);
        }
      };
      input.click();
    }

    function processarArquivoDrop(file) {
      if (file.name.endsWith(".json")) carregarConfigArquivo(file);
      else if (file.name.endsWith(".csv")) carregarCSVArquivo(file);
    }

    function carregarConfigArquivo(file) {
      lerArquivo(file).then(text => {
        config = JSON.parse(text);
        console.log("Configuração carregada", config);
        gerarEstilosDinamicos();
      });
    }

    function gerarEstilosDinamicos() {
      // Remove estilo anterior, se existir
      let old = document.getElementById("dynamic-timeline-styles");
      if (old) old.remove();

      // Cria novo <style>
      const styleEl = document.createElement("style");
      styleEl.id = "dynamic-timeline-styles";

      config.arquivos.forEach(a => {
        // a.identificador_arquivo = 'ferias' ou 'deslocamentos'
        // a.campos.cor = cor definida no JSON
        styleEl.appendChild(document.createTextNode(`
      .vis-item.${a.identificador_arquivo} {
        background-color: ${a.cor};
      }
    `));
      });

      document.head.appendChild(styleEl);
    }

    function carregarCSVArquivo(file) {
      if (!config) {
        alert("Carregue primeiro uma configuração JSON.");
        return;
      }
      lerArquivo(file).then(text => {
        const sep = identificarSeparador(text);
        const dados = parseCSV(text, sep);

        // Encontra qual entrada da configuração corresponde a este CSV
        const match = config.arquivos.find(a =>
          file.name.includes(a.identificador_arquivo || "")
        );
        if (!match) {
          alert("CSV não corresponde a nenhuma entrada na configuração.");
          return;
        }

        // Para cada linha, guarda os campos e a categoria (identificador_arquivo)
        dados.forEach(r => {
          r.__campos = match.campos;
          r.categoria = match.identificador_arquivo;
          r.nome_categoria = match.nome;
        });

        registros.push(...dados);
        atualizarTimeline();
      });
    }

    // Converte "DD/MM/YYYY" em um objeto Date
    function parseDateBR(str) {
      const [dia, mes, ano] = str.split('/');
      // mês-1 pois em JS janeiro = 0
      return new Date(+ano, mes - 1, +dia);
    }

    function atualizarTimeline() {
      items.clear();
      if (registros.length === 0) return;

      registros.forEach(r => {
        const c = r.__campos;
        const inicioBR = r[c.inicio];
        const fimBR = r[c.fim];
        if (!inicioBR || !fimBR) return;

        const item = {
          id: `${r[c.id]}-${inicioBR}`,
          content: `<strong>${r[c.nome]}</strong>`,
          start: parseDateBR(inicioBR),
          end: parseDateBR(fimBR),
          className: r.categoria,
          title: r.nome_categoria
        };
        items.add(item);        
      });

      timeline.setItems(items);
    }

    function salvarCalendarioCompleto() {
      if (!config) { alert("Nenhuma configuração carregada."); return; }
      const dados = { config, registros };
      const blob = new Blob([JSON.stringify(dados)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "calendario_completo.json"; a.click();
      URL.revokeObjectURL(url);
    }

    function carregarCalendarioCompleto(file) {
      lerArquivo(file).then(text => {
        const obj = JSON.parse(text);
        config = obj.config;
        registros = obj.registros;
        atualizarTimeline();
      });
    }

    function lerArquivo(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.onerror = e => rej(e);
        r.readAsText(file);
      });
    }

    function identificarSeparador(text) {
      return text.includes(";") ? ";" : ",";
    }

    function parseCSV(texto, sep = ",") {
      const linhas = texto.trim().split("\n");
      const cab = linhas.shift().split(sep).map(h => h.trim());
      return linhas.map(l => {
        const cols = l.split(sep).map(c => c.trim());
        return Object.fromEntries(cab.map((h, i) => [h, cols[i]]));
      });
    }
  </script>
</body>

</html>