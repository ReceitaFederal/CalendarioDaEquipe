<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Calendário da Equipe</title>

  <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js" defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .layout {
      display: flex;
      gap: 16px;
      margin-top: 10px;
    }

    .sidebar {
      width: 260px;
      min-width: 220px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      height: 600px;
      overflow: auto;
    }

    .sidebar h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    .member-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .member-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }

    .member-item:hover {
      background: #f5f5f5;
    }

    .member-item.selected {
      background: #e8f0fe;
      outline: 2px solid #90caf9;
    }

    .member-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #999;
      flex: 0 0 10px;
    }

    .main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #timeline {
      border: 1px solid #ddd;
      height: 600px;
    }

    .controls button,
    .controls input,
    .controls label {
      margin: 5px;
      vertical-align: middle;
    }

    /* Legenda */
    #legend {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      margin-right: 4px;
      font-size: 14px;
    }

    .legend-color-box {
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border: 1px solid #ccc;
    }

    /* Highlight “super legal” */
    .vis-item.highlighted {
      border: 3px solid #000000 !important;
      box-shadow: 0 0 12px 4px rgba(0, 0, 0, 0.8);
    }
  </style>
</head>

<body>
  <h1>Calendário da Equipe</h1>

  <div class="controls">
    <button id="btnReset">Limpar Calendário</button>
    <button id="btnLoadConfig">Carregar Configuração</button>
    <button id="btnLoadCSV">Carregar CSV</button>
    <button id="btnSaveAll">Salvar Calendário Completo</button>
    <button id="btnLoadAll">Carregar Calendário Completo</button>
    <button id="btnCalcDisp">Calcular Disponibilidade</button>
    <input type="file" id="fileInput" style="display:none" />
  </div>

  <!-- CONTROLES PARA INCLUIR PERÍODO MANUAL -->
  <div id="novoPeriodo" class="controls" style="margin-top:10px;">
    <label for="selMembro">Membro:</label>
    <select id="selMembro"></select>

    <label for="selTipo">Tipo:</label>
    <select id="selTipo"></select>

    <label for="dtInicioManual">Início:</label>
    <input type="date" id="dtInicioManual" />

    <label for="dtFimManual">Fim:</label>
    <input type="date" id="dtFimManual" />

    <button id="btnIncluir">Incluir</button>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <h2>Membros</h2>
      <ul id="memberList" class="member-list"></ul>
    </aside>

    <section class="main">
      <div id="legend"></div>
      <div id="timeline"></div>
    </section>
  </div>

  <script>
    let config = null;
    let registros = [];
    // id ↔ nome dos membros
    let membrosMap = new Map();
    // seleção atual de membros (para sincronizar lista ↔ timeline)
    const selectedMembros = new Set();

    let container, timeline;
    let items;

    document.addEventListener("DOMContentLoaded", () => {
      container = document.getElementById("timeline");
      inicializarEstruturas();
      inicializarTimeline();
      configurarEventos();
    });

    function inicializarEstruturas() {
      items = new vis.DataSet();
    }

    function inicializarTimeline() {
      const options = {
        stack: true,
        orientation: 'top',
        margin: { item: 10, axis: 5 }
      };
      timeline = new vis.Timeline(container, items, options);

      // Clique na timeline → alterna seleção do membro e sincroniza com a lista
      timeline.on('click', (properties) => {
        if (!properties.item) return;
        const clicked = items.get(properties.item);
        if (!clicked) return;
        const membroId = clicked.membroId ?? String(clicked.id).split('-')[0];
        toggleMembroSelection(membroId);
      });
    }

    function configurarEventos() {
      document.getElementById("btnReset").onclick = resetarTimeline;
      document.getElementById("btnLoadConfig").onclick = () => selecionarArquivo("json", carregarConfigArquivo);
      document.getElementById("btnLoadCSV").onclick = () => selecionarArquivo("csv", carregarCSVArquivo);
      document.getElementById("btnSaveAll").onclick = salvarCalendarioCompleto;
      document.getElementById("btnLoadAll").onclick = () => selecionarArquivo("json", carregarCalendarioCompleto);
      document.getElementById("btnCalcDisp").onclick = gerarDisponibilidade;
      document.getElementById("btnIncluir").onclick = incluirPeriodoManual;

      // Clique na lista de membros (delegação)
      document.getElementById("memberList").addEventListener("click", (e) => {
        const li = e.target.closest(".member-item");
        if (!li) return;
        const membroId = li.dataset.memberId;
        if (!membroId) return;
        toggleMembroSelection(membroId);
      });
    }

    function resetarTimeline() {
      inicializarEstruturas();
      timeline.setItems(items);
      config = null;
      registros = [];
      membrosMap.clear();
      selectedMembros.clear();
      document.getElementById('legend').innerHTML = '';
      renderMemberList();
    }

    function selecionarArquivo(tipo, callback) {
      const input = document.getElementById("fileInput");
      input.accept = tipo === "json" ? ".json" : ".csv";
      input.onchange = e => {
        if (e.target.files[0]) {
          callback(e.target.files[0]);
        }
      };
      input.click();
    }

    function carregarConfigArquivo(file) {
      lerArquivo(file).then(text => {
        config = JSON.parse(text);
        gerarEstilosDinamicos();
        popularSelectTipo();
        gerarLegenda();
      });
    }

    function gerarEstilosDinamicos() {
      let old = document.getElementById("dynamic-timeline-styles");
      if (old) old.remove();
      const styleEl = document.createElement("style");
      styleEl.id = "dynamic-timeline-styles";
      config.arquivos.forEach(a => {
        styleEl.appendChild(document.createTextNode(
          `.vis-item.${a.identificador_arquivo} { background-color: ${a.cor}; }\n`
        ));
      });
      document.head.appendChild(styleEl);
    }

    function gerarLegenda() {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      config.arquivos.forEach(a => {
        if (a.tipo !== 'membros') {
          const item = document.createElement('div');
          item.className = 'legend-item';
          const box = document.createElement('div');
          box.className = 'legend-color-box';
          box.style.backgroundColor = a.cor;
          item.appendChild(box);
          item.appendChild(document.createTextNode(a.nome));
          legend.appendChild(item);
        }
      });
    }

    function carregarCSVArquivo(file) {
      if (!config) { alert("Carregue primeiro uma configuração JSON."); return; }
      lerArquivo(file).then(text => {
        const sep = identificarSeparador(text);
        const dados = parseCSV(text, sep);
        const match = config.arquivos.find(a => file.name.toLowerCase().includes((a.identificador_arquivo || "").toLowerCase()));
        if (!match) { alert("CSV não corresponde a nenhuma entrada na configuração."); return; }

        if (match.tipo === 'membros') {
          dados.forEach(r => membrosMap.set(r[match.campos.id], r[match.campos.nome]));
          popularSelectMembro();
          renderMemberList();
          return;
        }

        dados.forEach(r => {
          r.__campos = match.campos;
          r.categoria = match.identificador_arquivo;
          r.nome_categoria = match.nome;
        });
        registros.push(...dados);
        atualizarTimeline();
      });
    }

    function parseDateBR(str) {
      const [dia, mes, ano] = str.split('/');
      return new Date(+ano, mes - 1, +dia);
    }

    function uid() {
      if (window.crypto?.randomUUID) return crypto.randomUUID();
      return (Date.now().toString(36) + Math.random().toString(36).slice(2, 10)).toUpperCase();
    }

    function atualizarTimeline() {
      items.clear();
      if (registros.length > 0) {
        registros.forEach(r => {
          const c = r.__campos;
          const inicioBR = r[c.inicio];
          const fimBR = r[c.fim];
          const baseId = r[c.id]; // id do membro
          const uniqueId = `${baseId}-${uid()}`;
          if (!inicioBR || !fimBR) return;

          items.add({
            id: uniqueId,
            membroId: baseId,
            content: `<strong>${r[c.nome]}</strong>`,
            start: parseDateBR(inicioBR),
            end: parseDateBR(fimBR),
            className: r.categoria,
            title: r.nome_categoria
          });
        });
      }

      // Reaplica destaques com base na seleção atual
      aplicarHighlightsDaSelecao();
      timeline.setItems(items);
    }

    function salvarCalendarioCompleto() {
      if (!config) { alert("Nenhuma configuração carregada."); return; }
      const dados = { config, registros };
      const blob = new Blob([JSON.stringify(dados)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "calendario_completo.json"; a.click();
      URL.revokeObjectURL(url);
    }

    function carregarCalendarioCompleto(file) {
      lerArquivo(file).then(text => {
        const obj = JSON.parse(text);
        config = obj.config;
        registros = obj.registros;
        gerarEstilosDinamicos();
        popularSelectTipo();
        gerarLegenda();
        atualizarTimeline();
      });
    }

    function lerArquivo(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.onerror = e => rej(e);
        r.readAsText(file);
      });
    }

    function identificarSeparador(text) {
      return text.includes(";") ? ";" : ",";
    }

    function parseCSV(texto, sep = ",") {
      const linhas = texto.trim().split("\n");
      const cab = linhas.shift().split(sep).map(h => h.trim());
      return linhas.map(l => {
        const cols = l.split(sep).map(c => c.trim());
        return Object.fromEntries(cab.map((h, i) => [h, cols[i]]));
      });
    }

    // --- DISPONIBILIDADE ---
    function gerarDisponibilidade() {
      const size = membrosMap.size;
      const daily = calcularDisponibilidade(size);
      const periods = agruparPeriodos(daily);
      adicionarItensDisponibilidade(periods, size);
    }

    function calcularDisponibilidade(size) {
      const daily = [];
      if (registros.length === 0) return daily;
      let minDate = Infinity, maxDate = -Infinity;
      registros.forEach(r => {
        const start = parseDateBR(r.__campos.inicio ? r[r.__campos.inicio] : r.inicio);
        const end = parseDateBR(r.__campos.fim ? r[r.__campos.fim] : r.fim);
        minDate = Math.min(minDate, start);
        maxDate = Math.max(maxDate, end);
      });
      let curr = new Date(minDate);
      curr.setHours(0, 0, 0, 0);
      const last = new Date(maxDate);
      last.setHours(0, 0, 0, 0);
      while (curr <= last) {
        const date = new Date(curr);
        const busy = registros.filter(r => {
          const start = parseDateBR(r.__campos.inicio ? r[r.__campos.inicio] : r.inicio);
          const end = parseDateBR(r.__campos.fim ? r[r.__campos.fim] : r.fim);
          return date >= start && date <= end;
        }).length;
        daily.push({ date: new Date(date), avail: size - busy });
        curr.setDate(curr.getDate() + 1);
      }
      return daily;
    }

    function agruparPeriodos(daily) {
      const periods = [];
      if (daily.length === 0) return periods;
      let start = daily[0].date;
      let current = daily[0].avail;
      for (let i = 1; i < daily.length; i++) {
        if (daily[i].avail !== current) {
          periods.push({ start, end: daily[i - 1].date, avail: current });
          start = daily[i].date;
          current = daily[i].avail;
        }
      }
      periods.push({ start, end: daily[daily.length - 1].date, avail: current });
      return periods;
    }

    function adicionarItensDisponibilidade(periods, size) {
      // remove antigos background
      items.get({ filter: item => item.type === 'background' }).forEach(it => items.remove(it.id));
      periods.forEach((p, i) => {
        const ratio = size > 0 ? p.avail / size : 0;
        const g = Math.round(ratio * 255);
        const color = `rgb(0,${g},0)`;
        items.add({
          id: `disp-${i}`,
          type: 'background',
          start: p.start,
          end: new Date(p.end.getTime() + 24 * 60 * 60 * 1000),
          style: `background-color: ${color};`
        });
      });
      // reaplica destaque após inserir backgrounds
      aplicarHighlightsDaSelecao();
      timeline.setItems(items);
    }

    // --- LISTA E SELEÇÃO DE MEMBROS ---
    function renderMemberList() {
      const ul = document.getElementById("memberList");
      ul.innerHTML = '';

      // Ordena alfabeticamente pelo nome
      const entries = Array.from(membrosMap.entries()).sort((a, b) =>
        String(a[1]).localeCompare(String(b[1]), 'pt-BR', { sensitivity: 'base' })
      );

      for (const [id, nome] of entries) {
        const li = document.createElement("li");
        li.className = "member-item";
        li.dataset.memberId = id;

        const dot = document.createElement("span");
        dot.className = "member-dot";

        const text = document.createElement("span");
        text.textContent = nome;

        li.appendChild(dot);
        li.appendChild(text);

        if (selectedMembros.has(id)) li.classList.add("selected");
        ul.appendChild(li);
      }
    }

    function toggleMembroSelection(membroId) {
      if (selectedMembros.has(membroId)) selectedMembros.delete(membroId);
      else selectedMembros.add(membroId);
      aplicarHighlightsDaSelecao();
      aplicarSelecaoNaLista();
    }

    function aplicarSelecaoNaLista() {
      const ul = document.getElementById("memberList");
      ul.querySelectorAll(".member-item").forEach(li => {
        const id = li.dataset.memberId;
        if (selectedMembros.has(id)) li.classList.add("selected");
        else li.classList.remove("selected");
      });
    }

    function aplicarHighlightsDaSelecao() {
      const all = items.get();
      // limpa highlight de todos os itens "normais"
      all.forEach(it => {
        if (it.type === 'background') return;
        let cls = it.className || '';
        cls = cls.replace(/\s*highlighted/g, '');
        if (it.membroId && selectedMembros.has(String(it.membroId))) {
          cls = (cls + ' highlighted').trim();
        }
        items.update({ id: it.id, className: cls });
      });
      timeline.setItems(items);
    }

    // --- SELECTS E INCLUSÃO MANUAL ---
    function popularSelectMembro() {
      const sel = document.getElementById("selMembro");
      sel.innerHTML = '<option value="">Selecione</option>';
      // ordena pelo nome
      const entries = Array.from(membrosMap.entries()).sort((a, b) =>
        String(a[1]).localeCompare(String(b[1]), 'pt-BR', { sensitivity: 'base' })
      );
      for (const [id, nome] of entries) {
        const o = document.createElement("option");
        o.value = id;
        o.textContent = nome;
        sel.appendChild(o);
      }
    }

    function popularSelectTipo() {
      const sel = document.getElementById("selTipo");
      sel.innerHTML = '<option value="">Selecione</option>';
      config.arquivos.forEach(a => {
        if (a.tipo !== 'membros') {
          const o = document.createElement("option");
          o.value = a.identificador_arquivo;
          o.textContent = a.nome;
          sel.appendChild(o);
        }
      });
    }

    function formatarDataParaBR(iso) {
      const [y, m, d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    function incluirPeriodoManual() {
      const idMembro = document.getElementById("selMembro").value;
      const tipo = document.getElementById("selTipo").value;
      const inicio = document.getElementById("dtInicioManual").value;
      const fim = document.getElementById("dtFimManual").value;

      if (!idMembro || !tipo || !inicio || !fim) {
        alert("Preencha todos os campos para incluir o período.");
        return;
      }

      const cfg = config.arquivos.find(a => a.identificador_arquivo === tipo);
      const reg = {};
      reg[cfg.campos.id] = idMembro;
      reg[cfg.campos.nome] = membrosMap.get(idMembro);
      reg[cfg.campos.inicio] = formatarDataParaBR(inicio);
      reg[cfg.campos.fim] = formatarDataParaBR(fim);
      reg.__campos = cfg.campos;
      reg.categoria = cfg.identificador_arquivo;
      reg.nome_categoria = cfg.nome;

      registros.push(reg);
      atualizarTimeline();
    }
  </script>
</body>

</html>
